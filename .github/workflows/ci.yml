name: CI - HR Pulse Quality Gate

# La pipeline se dÃ©clenche Ã  chaque push ou pull request sur la branche main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==========================================
  # ğŸ§¹ JOB 1 : Linting & QualitÃ© (Ruff)
  # ==========================================
  lint:
    name: Job 1 - Linting & QualitÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: ğŸ“¦ Installation de Ruff
        run: pip install ruff
        
      - name: ğŸ” VÃ©rification de la conformitÃ© du code
        # Ruff va scanner le dossier backend. S'il y a des erreurs de syntaxe ou des variables non utilisÃ©es, il fait Ã©chouer la pipeline.
        run: ruff check backend/

  # ==========================================
  # ğŸ§ª JOB 2 : Tests Unitaires (Pytest)
  # ==========================================
  test:
    name: Job 2 - Tests Unitaires
    needs: lint # Ce job attend que le Job 1 soit validÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          
      - name: ğŸ“¦ Installation des dÃ©pendances et outils de test
        run: |
          pip install -r backend/requirements.txt
          pip install pytest httpx
          
      - name: ğŸš¦ ExÃ©cution de Pytest
        env:
          # Permet Ã  pytest de trouver main.py
          PYTHONPATH: ${{ github.workspace }}/backend
        run: python -m pytest backend/tests/

  # ==========================================
  # ğŸ³ JOB 3 : Build Docker (VÃ©rification)
  # ==========================================
  build-docker:
    name: Job 3 - Build Images Docker
    needs: test # Ce job attend que le Job 2 soit validÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ³ Build Backend Image
        # On construit l'image pour vÃ©rifier qu'il n'y a pas d'erreur de dÃ©pendance
        run: docker build -t hr-pulse-backend:test ./backend

      - name: ğŸ³ Build Frontend Image
        # Idem pour le frontend (Next.js va vÃ©rifier les erreurs TypeScript au passage)
        run: docker build -t hr-pulse-frontend:test ./frontend